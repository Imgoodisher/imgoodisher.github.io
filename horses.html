<!DOCTYPE html>

<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
		<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css"> -->

		<style>
			#main-container {
				margin-top:25px;
			}

			.progress-bar {
				transition: none;
				-webkit-transition: none;
				-o-transition: none;
			}
		</style>
	</head>
	<body>
		<div class="container" id="main-container">
			<div class="row">
				<div class="col-md-8">
					<canvas id="graph"></canvas>
					<div class="progress">
						<div class="progress-bar" style="width:0%"></div> <!-- aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"  -->
					</div>
					<pre id="status"></pre>
				</div>
				<div class="col-md-4" id="options">
					<div class="form-group">
						<label class="control-label" for="trait">Select For:</label>
						<select class="form-control" id="trait">
							<option value="health">Health</option>
							<option value="speed">Speed</option>
							<option value="jump">Jump</option>
						</select>
					</div>

					<div class="form-group has-success">
						<label class="control-label" for="iterations">Iterations:</label>
						<input class="form-control" id="iterations" value="100">
					</div>

					<div class="form-group has-success">
						<label class="control-label" for="keep">Horses Kept Between Iterations:</label>
						<input class="form-control" id="keep" value="10">
					</div>

					<button type="button" class="btn btn-default btn-block" id="go">Go</button>
				</div>
			</div>
		</div>
		


		<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
		<script>
			var HEALTH_COLOR = "#FC6060"
			var SPEED_COLOR = "#60FC60"
			var JUMP_COLOR = "#6060FC"

			var worker = new Worker("/horse_worker.js");

			var data, totalIterations, keep;

			var canvas = $("#graph")[0];
			var ctx = canvas.getContext("2d");
			
			$(window).resize(function() {
				canvas.width = $(".col-md-8").width();
				canvas.height = canvas.width/2
			}).resize();

			function drawGraph() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);

				var scaleX = canvas.width / totalIterations;

				ctx.strokeStyle = HEALTH_COLOR;
				var scaleY = canvas.height / 16

				for (var i=0; i<keep; i++) {
					ctx.beginPath();
					ctx.moveTo(0, Math.floor(canvas.height - (data.health[0][i]-15) * scaleY));
					for (var j=0; j<data.health.length; j++) {
						ctx.lineTo(Math.floor(j * scaleX), Math.floor(canvas.height - (data.health[j][i]-15) * scaleY));
					}
					ctx.stroke();
				}

				ctx.strokeStyle = SPEED_COLOR;
				var scaleY = canvas.height / 0.225

				for (var i=0; i<keep; i++) {
					ctx.beginPath();
					ctx.moveTo(0, Math.floor(canvas.height - (data.speed[0][i]-0.1125) * scaleY));
					for (var j=0; j<data.speed.length; j++) {
						ctx.lineTo(Math.floor(j * scaleX), Math.floor(canvas.height - (data.speed[j][i]-0.1125) * scaleY));
					}
					ctx.stroke();
				}

				ctx.strokeStyle = JUMP_COLOR;
				var scaleY = canvas.height / 0.6

				for (var i=0; i<keep; i++) {
					ctx.beginPath();
					ctx.moveTo(0, Math.floor(canvas.height - (data.jump[0][i]-0.4) * scaleY));
					for (var j=0; j<data.jump.length; j++) {
						ctx.lineTo(Math.floor(j * scaleX), Math.floor(canvas.height - (data.jump[j][i]-0.4) * scaleY));
					}
					ctx.stroke();
				}
			}

			var $progress = $(".progress-bar");
			var $status = $("#status")

			worker.onmessage = function(evt) {
				var msg = evt.data;
				if (msg.type) {
					switch (msg.type) {
						case "data":
							data.totalHorses = msg.totalHorses;
							data.health.push(msg.health);
							data.speed.push(msg.speed);
							data.jump.push(msg.jump);
							//drawGraph();

							$progress.css("width", (msg.iterations / totalIterations)*100 + "%");
							$status.html("Highest Health: "+msg.health[0]/2+" hearts (max 15)<br>Highest Speed: ~"+msg.speed[0]*43+" blocks/second (max 14.5125)<br>Highest Jump: "+msg.jump[0]*5.5+" blocks (max 5.5)<br><br>Iterations: "+(msg.iterations+1)+"<br>Horses Bred: "+data.totalHorses);
							return;
						case "end":
							$progress.css("width", "100%");
							drawGraph();
							return;
						default:
							console.log(msg)
							return;
					}
				} else {
					console.log(msg);
				}
			}

			var number_regex = /^\d+$/

			$("#iterations,#keep").keyup(function() {
				if (number_regex.test($(this).val())) {
					$(this).parent().removeClass("has-error").addClass("has-success")
				} else {
					$(this).parent().removeClass("has-success").addClass("has-error")
				}
			})

			$("#go").click(function() {
				data = {totalHorses:0, health:[], speed:[], jump:[]}
				worker.postMessage({
					type: "begin", 
					trait: $("#trait").val(), 
					iterations: totalIterations = parseInt($("#iterations").val()),
					keep: keep = parseInt($("#keep").val())
				});
			})
		</script>
	</body>
</html>