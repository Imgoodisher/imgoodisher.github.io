<!DOCTYPE html>

<html>
	<head>
		<style>
			html, body {
				position:fixed;
				top:0px;
				bottom:0px;
				left:0px;
				right:0px;
				background-color:#222;
			}

			canvas {
				position:fixed;
				top:0px;
				left:0px;
			}

			audio {
				position:fixed;
				bottom:0px;
				left:0px;
				width:100%;
			}

			#options {
				color:#ccc;
				position:fixed;
				top:10px;
				left:10px;
				z-index:999;
				opacity:0.5;
			}

			#options p {
				margin: 8px 0px;
			}
		</style>
	</head>
	<body>
		<div id="options">
			<p>
				<input id="fileinput" type="file" accept="audio/*"/>
			</p>
			<p>
				<input id="urlinput" type="text" value="http://"/> <button id="loadURL">Load</button>
			</p>
			<p>
				Currently Loaded: <span id="current"></span>
			</p>
			<br>
			<p>
				<input id="opt_3d" type="checkbox"/> 3D
			</p>
		</div>
		<canvas id="canvas1"></canvas>
		<canvas id="canvas2"></canvas>
		<canvas id="canvas3"></canvas>
		<audio controls></audio>

		<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
		<script>
			var canvas1 = $("#canvas1")[0];
			var ctx1 = canvas1.getContext("2d");
			var canvas2 = $("#canvas2")[0];
			var ctx2 = canvas2.getContext("2d");
			var canvas3 = $("#canvas3")[0];
			var ctx3 = canvas3.getContext("2d");

			var enable3D = false


			function rotate(canvas, x, y, p) {
				var dist = Math.sqrt(Math.pow(x-canvas.width/2, 2)+Math.pow(y-canvas.height/2, 2))/Math.min(canvas.width, canvas.height)/2;
				var transform = "translateZ("+p+"px) rotate3d("+(-(y/canvas.height-0.5))+", "+((x/canvas.width-0.5))+", 0, "+(dist)+"rad)";
				$(canvas).css({
					"transform-origin": "50% 50% "+(-p)+"px",
					"transform": transform
				});
			}


			$(window).resize(function() {
				canvas1.width = canvas2.width = canvas3.width = window.innerWidth;
				canvas1.height = canvas2.height = canvas3.height = window.innerHeight;
			}).resize().mousemove(function(evt) {
				if (enable3D) {
					rotate(canvas1, evt.pageX, evt.pageY, -200);
					rotate(canvas2, evt.pageX, evt.pageY, 0);
					rotate(canvas3, evt.pageX, evt.pageY, 200);
				}
			})


			var audio = new (window.AudioContext || window.webkitAudioContext)();

			var audioElem = $("audio")[0];
			var source = audio.createMediaElementSource(audioElem);

			var analyser = audio.createAnalyser();
			analyser.fftSize = 512;

			source.connect(analyser);
			analyser.connect(audio.destination);


			var filename_regex = /[\/\\]([^\/\\]+)$/
			$("#fileinput").change(function() {
				var res = filename_regex.exec(this.value);
				$("#current").text(res ? res[1] : this.value);
				$(audioElem).attr("src", URL.createObjectURL(this.files[0]));
			});

			$("#loadURL").click(function() {
				var val = $("#urlinput").val();
				$("#current").text(val);
				$(audioElem).attr("src", val);
			})

			$("#opt_3d").change(function() {
				enable3D = this.checked;
				if (!enable3D) {
					$("canvas").css("transform", "none");
				}
			})


			var circleOffsets = []
			for (i=0; i<16; i++) {
				circleOffsets[i] = Math.random()*2*Math.PI
			}

			var wave = new Uint8Array(analyser.fftSize);
			var freq = new Uint8Array(analyser.frequencyBinCount);
			function draw() {
				requestAnimationFrame(draw);


				ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
				ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
				ctx3.clearRect(0, 0, canvas3.width, canvas3.height);
				

				analyser.getByteFrequencyData(freq);

				var w = canvas1.width / analyser.frequencyBinCount;

				var totalFreq = 0;

				ctx1.strokeStyle = "#00f";
				for (var i=0; i<analyser.frequencyBinCount; i++) {
					var height = freq[i]/128*(canvas1.height/2);
					var x = canvas1.width/2 + (i%2==0?1:-1)*Math.ceil(i/2)*2*w;

					ctx1.beginPath();
					ctx1.moveTo(x, canvas1.height/2 - height/2);
					ctx1.lineTo(x, canvas1.height/2 + height/2);
					ctx1.stroke();

					totalFreq+=freq[i];
				}




				ctx2.lineWidth = 2;

				analyser.getByteTimeDomainData(wave);

				var w = canvas1.width / analyser.fftSize;

				var maxAmp = 0;
				var totalDiff = 0;
				var totalDiffSize = 0;

				ctx2.beginPath()
				for (i = 0; i<analyser.fftSize; i++) {
					ctx2.lineTo(i*w, (wave[i]/128)*(canvas2.height/2));

					maxAmp = Math.max(maxAmp, Math.abs(wave[i]-64));
					for (j=-4; j<4; j++) {
						if (wave[i+j]) {
							totalDiff += Math.abs(wave[i]-wave[i+j])
							totalDiffSize++;
						}
					}
				}
				ctx2.strokeStyle = "#f00";
				ctx2.stroke();




				ctx3.lineWidth = 2;

				var maxFreq = 256*analyser.frequencyBinCount;
				var avgFreq = totalFreq / maxFreq;

				var maxSize = Math.min(canvas3.width, canvas3.height)/2;
				var r = avgFreq*maxSize

				var avgDiff = totalDiff / totalDiffSize;

				var waveSize = Math.pow(1+(avgDiff / maxAmp * 256), 1.75);

				ctx3.strokeStyle = "#0f0";
				ctx3.beginPath();
				for (var t=0; t<2*Math.PI; t+=Math.PI/128) {
					var w = 0
					for (var i=0; i<16; i++) {
						w += Math.sin((t+circleOffsets[i])*Math.floor(Math.pow(i, 1.25)/2))*(freq[i*analyser.frequencyBinCount/16]/160);
					}
					var r2 = r + (w/16)*waveSize;
					ctx3.lineTo(canvas3.width/2 + Math.cos(t)*r2, canvas3.height/2 + Math.sin(t)*r2)
				}

				ctx3.stroke()


				for (i=0; i<16; i++) {
					circleOffsets[i] = (circleOffsets[i] + (Math.random()-0.5)/(16-i)*3)%(2*Math.PI)
				}
			}
			draw()
		</script>
	</body>
</html>